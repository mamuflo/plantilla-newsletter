<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Generador de Newsletter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/5.10.3/tinymce.min.js"></script>
    <script>
      tinymce.init({
        selector: 'textarea',
        plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak',
        toolbar_mode: 'floating',
      });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        body { 
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #f7f9fc;
            margin: 0;
            padding: 2em;
            color: #333;
        }
        h1 { 
            color: #003366; 
            text-align: center;
            margin-bottom: 1em;
            font-weight: 700;
        }
        form { 
            background-color: #fff; 
            padding: 2.5em;
            border-radius: 12px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            max-width: 900px;
            margin: 0 auto;
        }
        fieldset { 
            border: none;
            padding: 2em;
            margin-bottom: 1.5em; 
            border-radius: 8px; 
            transition: box-shadow 0.3s ease;
            border-left: 5px solid;
        }
        fieldset:nth-of-type(1) { background-color: #e8f4fd; border-left-color: #5b9bd5; }
        fieldset:nth-of-type(2) { background-color: #eef7ff; border-left-color: #82c0ff; }
        fieldset:nth-of-type(3) { background-color: #eefcfa; border-left-color: #7ee2d8; }
        fieldset:nth-of-type(4) { background-color: #fef8e8; border-left-color: #ffd97d; }
        fieldset:nth-of-type(5) { background-color: #fdeef4; border-left-color: #f7a8d0; }
        fieldset:nth-of-type(6) { background-color: #f0eefd; border-left-color: #b1a8f7; }
        fieldset:nth-of-type(7) { background-color: #eefdef; border-left-color: #a8f7a8; }

        fieldset:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        legend { 
            font-size: 1.5em; 
            font-weight: 700; 
            color: #005a9e; 
            margin-bottom: 1em;
            width: 100%;
            padding-bottom: 0.5em;
            border-bottom: 1px solid #ddd;
        }
        label { 
            display: block; 
            margin-bottom: 0.5em; 
            font-weight: 700; 
            color: #555; 
        }
        input[type="text"], textarea {
            width: calc(100% - 24px); 
            padding: 12px; 
            margin-bottom: 1.5em; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus, textarea:focus {
            border-color: #005a9e;
            box-shadow: 0 0 8px rgba(0, 90, 158, 0.2);
            outline: none;
        }
        textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .button-container { 
            text-align: center; 
            padding-top: 1em;
        }
        input[type="submit"], .upload-button, .auth-button { 
            background-color: #005a9e; 
            color: white; 
            padding: 15px 40px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.2em; 
            font-weight: 700;
            cursor: pointer; 
            transition: background-color 0.3s, transform 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        input[type="submit"]:hover, .upload-button:hover, .auth-button:hover {
            background-color: #003366;
            transform: translateY(-2px);
        }
        .upload-button {
            font-size: 0.9em;
            padding: 10px 20px;
            margin-left: 10px;
        }
        .resource-item {
            display: flex;
            align-items: center;
            margin-bottom: 1em;
        }
        .resource-item input[type="file"] {
            flex-grow: 1;
        }
        .status-indicator {
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 1em;
        }
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>

    <h1>Generador de Contenido para Newsletter</h1>
    <form action="/" method="post">

        <fieldset>
            <legend>Subida de Recursos</legend>
            {% if not credentials_exist %}
                <p>Para subir tus imágenes y vídeos, primero necesitas conectar tu cuenta de Google.</p>
                <a href="/authorize" class="auth-button">Conectar con Google</a>
                <div class="status-indicator status-disconnected">Estado: No conectado</div>
            {% else %}
                <div class="status-indicator status-connected">Estado: Conectado a Google. ¡Listo para subir!</div>
            {% endif %}
            
            <div id="upload-section" {% if not credentials_exist %}style="display:none;"{% endif %}>
                
                <h4>Configuración de Google Drive</h4>
                <div class="resource-item">
                    <label for="drive_folder_name" style="flex-basis: 200px;">Carpeta en Drive:</label>
                    <input type="text" id="drive_folder_name" placeholder="Ej: Newsletter_Imagenes" style="margin-bottom: 0;">
                    <button type="button" class="upload-button" onclick="getOrCreateFolder()">Crear/Usar Carpeta</button>
                </div>
                <input type="hidden" id="drive_folder_id">
                <hr style="margin: 2em 0;">

                <h4>Imágenes (subir a Google Drive)</h4>
                <div class="resource-item">
                    <label for="header_logo_src_upload" style="flex-basis: 200px;">Logo (Cabecera):</label>
                    <input type="file" id="header_logo_src_upload" accept="image/*">
                    <button type="button" class="upload-button" onclick="uploadFile('header_logo_src_upload', 'header_logo_src', 'image')">Subir</button>
                </div>
                <div class="resource-item">
                    <label for="hero_src_upload" style="flex-basis: 200px;">Banner Principal:</label>
                    <input type="file" id="hero_src_upload" accept="image/*">
                    <button type="button" class="upload-button" onclick="uploadFile('hero_src_upload', 'hero_src', 'image')">Subir</button>
                </div>
                <div class="resource-item">
                    <label for="section1_img_src_upload" style="flex-basis: 200px;">Imagen (Sección 1):</label>
                    <input type="file" id="section1_img_src_upload" accept="image/*">
                    <button type="button" class="upload-button" onclick="uploadFile('section1_img_src_upload', 'section1_img_src', 'image')">Subir</button>
                </div>
                <div class="resource-item">
                    <label for="section2_img_src_upload" style="flex-basis: 200px;">Imagen (Sección 2):</label>
                    <input type="file" id="section2_img_src_upload" accept="image/*">
                    <button type="button" class="upload-button" onclick="uploadFile('section2_img_src_upload', 'section2_img_src', 'image')">Subir</button>
                </div>
                 <div class="resource-item">
                    <label for="video_thumbnail_src_upload" style="flex-basis: 200px;">Miniatura Vídeo:</label>
                    <input type="file" id="video_thumbnail_src_upload" accept="image/*">
                    <button type="button" class="upload-button" onclick="uploadFile('video_thumbnail_src_upload', 'video_thumbnail_src', 'image')">Subir</button>
                </div>

                <h4>Vídeo (subir a YouTube)</h4>
                <div class="resource-item">
                    <label for="video_link_upload" style="flex-basis: 200px;">Vídeo Principal:</label>
                    <input type="file" id="video_link_upload" accept="video/*">
                    <button type="button" class="upload-button" onclick="uploadFile('video_link_upload', 'video_link', 'video')">Subir</button>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>1. Cabecera y Banner</legend>
            <label for="title">Título de la Página (pestaña del navegador):</label>
            <input type="text" id="title" name="title" value="Newsletter CITED Cantabria">

            <label for="header_logo_link">Enlace del Logo (Cabecera):</label>
            <input type="text" id="header_logo_link" name="header_logo_link" value="https://educantabria.es/web/cited">

            <label for="header_logo_src">URL de la Imagen del Logo (Cabecera):</label>
            <input type="text" id="header_logo_src" name="header_logo_src" value="https://www.educantabria.es/documents/21790824/0/Logo+Cited_Aula+del+futuro+%281%29.png">

            <label for="hero_link">Enlace del Banner Principal:</label>
            <input type="text" id="hero_link" name="hero_link" value="https://educantabria.es/web/cited">

            <label for="hero_src">URL de la Imagen del Banner Principal:</label>
            <input type="text" id="hero_src" name="hero_src" value="https://www.educantabria.es/documents/21790824/21790904/artificial-intelligence-3706562_1920.jpg">

            <label for="hero_alt">Texto Alternativo del Banner Principal:</label>
            <input type="text" id="hero_alt" name="hero_alt" value="Innovación y Formación CITED">
        </fieldset>

        <fieldset>
            <legend>2. Contenido Introductorio</legend>
            <label for="intro_title">Título Principal:</label>
            <input type="text" id="intro_title" name="intro_title" value="Descubre el CITED: Tu Futuro Empieza Aquí">

            <label for="intro_p1">Párrafo de Introducción 1 (acepta HTML como &lt;strong&gt;):</label>
            <textarea id="intro_p1" name="intro_p1">El &lt;strong&gt;Centro de Innovación y Tecnología Educativa de Cantabria (CITED)&lt;/strong&gt; es tu punto de referencia para la transformación digital en la educación.</textarea>

            <label for="intro_p2">Párrafo de Introducción 2 (acepta HTML como &lt;strong&gt;):</label>
            <textarea id="intro_p2" name="intro_p2">Explora nuestras nuevas líneas de formación, programas, recursos y proyectos diseñados para &lt;strong&gt;docentes&lt;/strong&gt; que buscan innovar en el aula.</textarea>
        </fieldset>

        <fieldset>
            <legend>3. Sección 1 (Formación)</legend>
            <label for="section1_img_src">URL de la Imagen (Sección 1):</label>
            <input type="text" id="section1_img_src" name="section1_img_src" value="https://www.educantabria.es/documents/21790824/21790904/formacion.png">

            <label for="section1_img_alt">Texto Alternativo de la Imagen (Sección 1):</label>
            <input type="text" id="section1_img_alt" name="section1_img_alt" value="Formación para Docentes">

            <label for="section1_title">Título (Sección 1):</label>
            <input type="text" id="section1_title" name="section1_title" value="Formación del Profesorado">

            <label for="section1_p">Párrafo (Sección 1):</label>
            <textarea id="section1_p" name="section1_p">Actualiza tus competencias digitales, descubre metodologías activas y lidera el cambio en tu aula. Ofrecemos cursos prácticos, píldoras formativas y asesoramiento en proyectos de innovación.</textarea>

            <label for="section1_button_link">Enlace del Botón (Sección 1):</label>
            <input type="text" id="section1_button_link" name="section1_button_link" value="https://aulacited.educantabria.es">

            <label for="section1_button_text">Texto del Botón (Sección 1):</label>
            <input type="text" id="section1_button_text" name="section1_button_text" value="Ver Cursos para Docentes">
        </fieldset>

        <fieldset>
            <legend>4. Sección 2 (Programas)</legend>
            <label for="section2_img_src">URL de la Imagen (Sección 2):</label>
            <input type="text" id="section2_img_src" name="section2_img_src" value="https://www.educantabria.es/documents/21790824/21790904/programas.png">

            <label for="section2_img_alt">Texto Alternativo de la Imagen (Sección 2):</label>
            <input type="text" id="section2_img_alt" name="section2_img_alt" value="Programas CITED">

            <label for="section2_title">Título (Sección 2):</label>
            <input type="text" id="section2_title" name="section2_title" value="Nuestros Programas">

            <label for="section2_p">Párrafo (Sección 2):</label>
            <textarea id="section2_p" name="section2_p">Descubre los programas de innovación que impulsamos desde el CITED, diseñados para fomentar la integración de la tecnología y las nuevas metodologías en los centros educativos de Cantabria.</textarea>

            <label for="section2_button_link">Enlace del Botón (Sección 2):</label>
            <input type="text" id="section2_button_link" name="section2_button_link" value="https://www.educantabria.es/web/cited/programas1">

            <label for="section2_button_text">Texto del Botón (Sección 2):</label>
            <input type="text" id="section2_button_text" name="section2_button_text" value="Ver Todos los Programas">
        </fieldset>

        <fieldset>
            <legend>5. Sección de Vídeo</legend>
            <label for="video_title">Título del Vídeo:</label>
            <input type="text" id="video_title" name="video_title" value="Conoce el CITED en 1 Minuto">

            <label for="video_p">Párrafo del Vídeo:</label>
            <textarea id="video_p" name="video_p">Descubre nuestras instalaciones y todo lo que podemos ofrecerte en este breve video.</textarea>

            <label for="video_link">Enlace al Archivo de Vídeo o Página:</label>
            <input type="text" id="video_link" name="video_link" value="https://www.educantabria.es/documents/21790824/21790889/Bienvenid%40s+al+CITED.mp4">

            <label for="video_thumbnail_src">URL de la Imagen Miniatura del Vídeo:</label>
            <input type="text" id="video_thumbnail_src" name="video_thumbnail_src" value="https://www.educantabria.es/documents/21790824/21790904/video.png">

            <label for="video_thumbnail_alt">Texto Alternativo de la Miniatura:</label>
            <input type="text" id="video_thumbnail_alt" name="video_thumbnail_alt" value="Ver video sobre el CITED">
        </fieldset>

        <fieldset>
            <legend>7. Estilos de la Newsletter</legend>

            <label for="bg_type">Tipo de Fondo:</label>
            <select id="bg_type" name="bg_type">
                <option value="solid" {% if bg_type == 'solid' %}selected{% endif %}>Color Sólido</option>
                <option value="gradient" {% if bg_type == 'gradient' %}selected{% endif %}>Degradado</option>
            </select>

            <div id="solid_color_picker" style="display:{% if bg_type == 'gradient' %}none{% else %}block{% endif %};">
                <label for="bg_color">Color de Fondo:</label>
                <input type="color" id="bg_color" name="bg_color" value="{{ bg_color|default('#f2f2f2') }}">
            </div>

            <div id="gradient_color_picker" style="display:{% if bg_type == 'gradient' %}block{% else %}none{% endif %};">
                <label for="bg_color_1">Color de Fondo 1:</label>
                <input type="color" id="bg_color_1" name="bg_color_1" value="{{ bg_color_1|default('#f2f2f2') }}">
                <label for="bg_color_2">Color de Fondo 2:</label>
                <input type="color" id="bg_color_2" name="bg_color_2" value="{{ bg_color_2|default('#ffffff') }}">
            </div>

            <label for="title_color">Color de los Títulos:</label>
            <input type="color" id="title_color" name="title_color" value="{{ title_color|default('#333333') }}">

            <label for="title_font_size">Tamaño de los Títulos:</label>
            <select id="title_font_size" name="title_font_size">
                <option value="20px" {% if title_font_size == '20px' %}selected{% endif %}>20px</option>
                <option value="24px" {% if title_font_size == '24px' %}selected{% endif %}>24px</option>
                <option value="28px" {% if title_font_size == '28px' %}selected{% endif %}>28px</option>
                <option value="32px" {% if title_font_size == '32px' %}selected{% endif %}>32px</option>
            </select>

            <label for="text_color">Color de los Párrafos:</label>
            <input type="color" id="text_color" name="text_color" value="{{ text_color|default('#555555') }}">

            <label for="font_family">Tipo de Fuente:</label>
            <select id="font_family" name="font_family">
                <option value="Arial, sans-serif" {% if font_family == 'Arial, sans-serif' %}selected{% endif %}>Arial</option>
                <option value="Georgia, serif" {% if font_family == 'Georgia, serif' %}selected{% endif %}>Georgia</option>
                <option value="'Times New Roman', Times, serif" {% if font_family == "'Times New Roman', Times, serif" %}selected{% endif %}>Times New Roman</option>
                <option value="'Courier New', Courier, monospace" {% if font_family == "'Courier New', Courier, monospace" %}selected{% endif %}>Courier New</option>
                <option value="Verdana, Geneva, sans-serif" {% if font_family == 'Verdana, Geneva, sans-serif' %}selected{% endif %}>Verdana</option>
                <option value="'Roboto', sans-serif" {% if font_family == "'Roboto', sans-serif" %}selected{% endif %}>Roboto</option>
                <option value="'Open Sans', sans-serif" {% if font_family == "'Open Sans', sans-serif" %}selected{% endif %}>Open Sans</option>
                <option value="'Lato', sans-serif" {% if font_family == "'Lato', sans-serif" %}selected{% endif %}>Lato</option>
            </select>
        </fieldset>

        <fieldset>
            <legend>8. Pie de Página</legend>
            <label for="footer_web_link">Enlace Web del Pie de Página:</label>
            <input type="text" id="footer_web_link" name="footer_web_link" value="https://educantabria.es/web/cited">

            <label for="footer_web_text">Texto del Enlace Web del Pie de Página:</label>
            <input type="text" id="footer_web_text" name="footer_web_text" value="educantabria.es/web/cited">
        </fieldset>

        <div class="button-container">
            <input type="submit" value="Generar Newsletter">
        </div>

    </form>

    <script>
        document.getElementById('bg_type').addEventListener('change', function() {
            var solidPicker = document.getElementById('solid_color_picker');
            var gradientPicker = document.getElementById('gradient_color_picker');
            if (this.value === 'solid') {
                solidPicker.style.display = 'block';
                gradientPicker.style.display = 'none';
            } else {
                solidPicker.style.display = 'none';
                gradientPicker.style.display = 'block';
            }
        });

        function getOrCreateFolder() {
            const folderName = document.getElementById('drive_folder_name').value;
            if (!folderName) {
                alert("Por favor, introduce un nombre para la carpeta.");
                return;
            }

            const formData = new FormData();
            formData.append('folderName', folderName);

            fetch('/get_or_create_folder', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.folderId) {
                    document.getElementById('drive_folder_id').value = data.folderId;
                    alert(`Carpeta '${folderName}' lista para usar.`);
                } else {
                    throw new Error(data.error || 'No se pudo obtener el ID de la carpeta.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error al procesar la carpeta: " + error.message);
            });
        }

        function uploadFile(fileInputId, targetInputId, type) {
            const fileInput = document.getElementById(fileInputId);
            const file = fileInput.files[0];
            if (!file) {
                alert("Por favor, selecciona un archivo primero.");
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            if (type === 'image') {
                const folderId = document.getElementById('drive_folder_id').value;
                if (!folderId) {
                    alert("Por favor, primero crea o verifica una carpeta de Google Drive.");
                    return;
                }
                formData.append('folderId', folderId);
            }

            const targetInput = document.getElementById(targetInputId);
            const originalValue = targetInput.value;
            const uploadButton = fileInput.nextElementSibling;
            uploadButton.textContent = "Subiendo...";
            uploadButton.disabled = true;

            const endpoint = type === 'image' ? '/upload_image' : '/upload_video';

            fetch(endpoint, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la subida. Código de estado: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.url) {
                    targetInput.value = data.url;
                    alert("¡Subida completada! La URL ha sido actualizada.");
                } else {
                    throw new Error(data.error || 'No se recibió una URL.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error en la subida: " + error.message);
                targetInput.value = originalValue; // Revertir al valor original si hay error
            })
            .finally(() => {
                uploadButton.textContent = "Subir";
                uploadButton.disabled = false;
            });
        }
    </script>

</body>
</html>