<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Newsletter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/5.10.3/tinymce.min.js"></script>
    <script>
      tinymce.init({
        selector: 'textarea',
        plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak',
        toolbar_mode: 'floating',
      });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        body { 
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #f7f9fc;
            margin: 0;
            padding: 2em;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: #1a1a1a;
            color: #f1f1f1;
        }

        h1 { 
            color: #003366; 
            text-align: center;
            margin-bottom: 1em;
            font-weight: 700;
        }

        body.dark-mode h1 {
            color: #82c0ff;
        }

        form { 
            background-color: #fff; 
            padding: 2.5em;
            border-radius: 12px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            max-width: 900px;
            margin: 0 auto;
        }

        body.dark-mode form {
            background-color: #2c2c2c;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }

        fieldset { 
            border: none;
            padding: 2em;
            margin-bottom: 1.5em; 
            border-radius: 8px; 
            transition: box-shadow 0.3s ease;
            border-left: 5px solid;
            overflow: hidden;
            min-width: 0;
        }
        fieldset:nth-of-type(1) { background-color: #e8f4fd; border-left-color: #5b9bd5; }
        fieldset:nth-of-type(2) { background-color: #eef7ff; border-left-color: #82c0ff; }
        fieldset:nth-of-type(3) { background-color: #eefcfa; border-left-color: #7ee2d8; }
        fieldset:nth-of-type(4) { background-color: #fef8e8; border-left-color: #ffd97d; }
        fieldset:nth-of-type(5) { background-color: #fdeef4; border-left-color: #f7a8d0; }
        fieldset:nth-of-type(6) { background-color: #f0eefd; border-left-color: #b1a8f7; }
        fieldset:nth-of-type(7) { background-color: #eefdef; border-left-color: #a8f7a8; }

        body.dark-mode fieldset {
            background-color: #3a3a3a;
        }
        body.dark-mode fieldset:nth-of-type(1) { border-left-color: #5b9bd5; }
        body.dark-mode fieldset:nth-of-type(2) { border-left-color: #82c0ff; }
        body.dark-mode fieldset:nth-of-type(3) { border-left-color: #7ee2d8; }
        body.dark-mode fieldset:nth-of-type(4) { border-left-color: #ffd97d; }
        body.dark-mode fieldset:nth-of-type(5) { border-left-color: #f7a8d0; }
        body.dark-mode fieldset:nth-of-type(6) { border-left-color: #b1a8f7; }
        body.dark-mode fieldset:nth-of-type(7) { border-left-color: #a8f7a8; }


        fieldset:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body.dark-mode fieldset:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        legend { 
            font-size: 1.5em; 
            font-weight: 700; 
            color: #005a9e; 
            margin-bottom: 1em;
            width: 100%;
            padding-bottom: 0.5em;
            border-bottom: 1px solid #ddd;
        }

        body.dark-mode legend {
            color: #82c0ff;
            border-bottom-color: #555;
        }

        label { 
            display: block; 
            margin-bottom: 0.5em; 
            font-weight: 700; 
            color: #555; 
        }

        body.dark-mode label {
            color: #ccc;
        }

        input[type="text"], textarea, select {
            width: calc(100% - 24px); 
            padding: 12px; 
            margin-bottom: 1.5em; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fff;
            color: #333;
        }

        body.dark-mode input[type="text"], body.dark-mode textarea, body.dark-mode select {
            background-color: #444;
            color: #f1f1f1;
            border-color: #666;
        }

        input[type="text"]:focus, textarea:focus, select:focus {
            border-color: #005a9e;
            box-shadow: 0 0 8px rgba(0, 90, 158, 0.2);
            outline: none;
        }

        body.dark-mode input[type="text"]:focus, body.dark-mode textarea:focus, body.dark-mode select:focus {
            border-color: #82c0ff;
            box-shadow: 0 0 8px rgba(130, 192, 255, 0.3);
        }

        textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        .button-container { 
            text-align: center; 
            padding-top: 1em;
        }
        input[type="submit"], .upload-button, .auth-button { 
            background-color: #005a9e; 
            color: white; 
            padding: 15px 40px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.2em; 
            font-weight: 700;
            cursor: pointer; 
            transition: background-color 0.3s, transform 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        input[type="submit"]:hover, .upload-button:hover, .auth-button:hover {
            background-color: #003366;
            transform: translateY(-2px);
        }

        body.dark-mode input[type="submit"], body.dark-mode .upload-button, body.dark-mode .auth-button {
            background-color: #82c0ff;
            color: #1a1a1a;
        }

        body.dark-mode input[type="submit"]:hover, body.dark-mode .upload-button:hover, body.dark-mode .auth-button:hover {
            background-color: #a9d3ff;
        }

        .upload-button {
            font-size: 0.9em;
            padding: 10px 20px;
            margin-left: 10px;
        }
        .resource-item {
            display: flex;
            align-items: center;
            margin-bottom: 1em;
            flex-wrap: wrap;
        }
        .resource-item input[type="file"] {
            flex-grow: 1;
        }
        .resource-label {
            flex-basis: 200px;
        }
        .status-indicator {
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 1em;
        }
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        body.dark-mode .status-connected {
            background-color: #155724;
            color: #d4edda;
        }

        body.dark-mode .status-disconnected {
            background-color: #721c24;
            color: #f8d7da;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #005a9e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s, transform 0.3s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        body.dark-mode .theme-toggle {
            background-color: #82c0ff;
            color: #1a1a1a;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 0.5em;
                font-size: 16px; /* Aumentar tama√±o de fuente base para m√≥vil */
                word-wrap: break-word; /* Evitar desbordamiento de palabras largas */
                word-break: break-all;
            }
            form {
                padding: 0.5em;
            }
            fieldset {
                padding: 1em 0.5em; /* Reducir padding horizontal en fieldsets */
            }
            h1 {
                font-size: 1.8em;
            }
            legend {
                font-size: 1.3em;
            }
            
            input[type="text"], textarea, select, input[type="color"] {
                width: 100%;
                padding: 15px; /* Hacerlos m√°s altos y f√°ciles de tocar */
                font-size: 1em; /* Tama√±o de fuente legible */
                box-sizing: border-box; /* Asegurar que el padding no cause desbordamiento */
                margin-left: 0;
                margin-right: 0;
            }

            .resource-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .resource-item label, .resource-label {
                margin-bottom: 0.5em;
                flex-basis: auto; /* Resetear base */
            }
            .resource-item input[type="file"], .resource-item select, .resource-item input[type="text"] {
                width: 100%;
                margin-bottom: 1em;
                box-sizing: border-box;
            }
            .upload-button, .auth-button {
                margin-left: 0;
                width: 100%;
                padding: 15px;
                font-size: 1.1em;
                box-sizing: border-box; /* A√±adido para incluir el padding en el ancho total */
            }
            input[type="submit"] {
                width: 100%;
                padding: 18px; /* Bot√≥n principal m√°s grande */
                font-size: 1.2em;
            }
            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 45px;
                height: 45px;
            }
            .tox-tinymce {
                width: 100% !important;
                box-sizing: border-box;
            }
        }

        @media (max-width: 400px) {
            body {
                padding: 0;
            }
            form {
                padding: 0;
                border-radius: 0;
            }
            fieldset {
                padding: 1em 0.2em;
                margin-left: 0;
                margin-right: 0;
                border-left-width: 2px;
            }
        }

        /* Estilos para el Modal de Confirmaci√≥n de Borrado */
        .delete-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002; /* Por encima del otro modal */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .delete-modal-content {
            background-color: #fff;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        body.dark-mode .delete-modal-content {
            background-color: #2c2c2c;
        }
        .delete-modal-content p {
            margin-top: 0;
            margin-bottom: 1.5em;
        }
        .delete-modal-actions {
            display: flex;
            justify-content: center;
            gap: 1em;
        }

    </style>
</head>
<body>

    <button id="theme-toggle" class="theme-toggle">üåô</button>

    <h1>Generador de Contenido para Newsletter</h1>
    <form action="{{ url_for('index') }}" method="post" style="position: relative;">

        {% if credentials_exist %}
        <div style="position: absolute; top: 20px; right: 20px;">
            <a href="{{ url_for('logout') }}" class="auth-button" style="padding: 8px 15px; font-size: 0.9em; background-color: #6c757d;">Desconectar de Google</a>
        </div>
        {% endif %}

        <!-- Bot√≥n y Modal para Cargar Plantillas -->
        <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
            <button type="button" id="load-template-btn" style="padding: 10px 15px; font-size: 1em; margin-bottom: 10px;">Cargar Plantilla</button>
            <h4 style="margin-top: 15px; margin-bottom: 10px; border-top: 1px solid #ccc; padding-top: 15px;">Gesti√≥n de plantillas en Drive</h4>
            <!-- Desplegable y bot√≥n para borrar plantillas -->
            <select id="template-delete-select" style="padding: 10px; font-size: 1em; display: none; width: 100%; box-sizing: border-box; margin-bottom: 10px;"></select>
            <button type="button" id="delete-template-btn" style="padding: 10px 15px; font-size: 1em; background-color: #dc3545; color: white; border: none; border-radius: 5px; display: none; width: 100%; box-sizing: border-box;">Borrar Seleccionada</button>
        </div>

        <!-- El Modal (inicialmente oculto) -->
        <div id="template-modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;">
                <span id="close-modal-btn" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <h4>Selecciona una plantilla para cargar:</h4>
                <ul id="template-list" style="list-style-type: none; padding: 0;">
                    <!-- La lista de plantillas se insertar√° aqu√≠ din√°micamente -->
                </ul>
            </div>
        </div>

        <!-- Modal de Confirmaci√≥n de Borrado -->
        <div id="delete-confirm-modal" class="delete-modal-overlay">
            <div class="delete-modal-content">
                <p id="delete-modal-text">¬øEst√°s seguro de que quieres borrar esta plantilla? Esta acci√≥n no se puede deshacer.</p>
                <div class="delete-modal-actions">
                    <button id="delete-modal-cancel-btn" class="upload-button" style="background-color: #6c757d;">Cancelar</button>
                    <button type="button" id="delete-modal-confirm-btn" class="upload-button" style="background-color: #dc3545;">Confirmar Borrado</button>
                </div>
            </div>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loadBtn = document.getElementById('load-template-btn');
            const modal = document.getElementById('template-modal');
            const closeBtn = document.getElementById('close-modal-btn');
            const templateList = document.getElementById('template-list');
            
            const deleteSelect = document.getElementById('template-delete-select');
            const deleteBtn = document.getElementById('delete-template-btn');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteModalText = document.getElementById('delete-modal-text');
            const deleteCancelBtn = document.getElementById('delete-modal-cancel-btn');
            const deleteConfirmBtn = document.getElementById('delete-modal-confirm-btn');
            let templateIdToDelete = null;

            function fetchTemplates() {
                fetch('/list_templates')
                    .then(response => {
                        if (!response.ok) throw new Error('Error de autenticaci√≥n o del servidor.');
                        return response.json();
                    })
                    .then(templates => {
                        templateList.innerHTML = ''; 
                        deleteSelect.innerHTML = '';

                        if (templates.length > 0) {
                            templates.forEach(template => {
                                // Rellenar modal de carga
                                const listItem = document.createElement('li');
                                const link = document.createElement('a');
                                link.href = '/load_template/' + template.id;
                                link.textContent = template.name;
                                link.style.display = 'block';
                                link.style.padding = '8px 12px';
                                link.style.textDecoration = 'none';
                                link.style.color = '#007bff';
                                link.onmouseover = function() { this.style.backgroundColor = '#f0f0f0'; };
                                link.onmouseout = function() { this.style.backgroundColor = 'transparent'; };
                                listItem.appendChild(link);
                                templateList.appendChild(listItem);

                                // Rellenar desplegable de borrado
                                const option = document.createElement('option');
                                option.value = template.id;
                                option.textContent = template.name;
                                deleteSelect.appendChild(option);
                            });
                            deleteSelect.style.display = 'inline-block';
                            deleteBtn.style.display = 'inline-block';
                        } else {
                            templateList.innerHTML = '<li style="padding: 8px;">No se encontraron plantillas.</li>';
                            deleteSelect.style.display = 'none';
                            deleteBtn.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        templateList.innerHTML = '<li style="padding: 8px; color: red;">Error al cargar plantillas.</li>';
                        deleteSelect.style.display = 'none';
                        deleteBtn.style.display = 'none';
                    });
            }

            // --- Event Listeners ---

            loadBtn.addEventListener('click', function() {
                templateList.innerHTML = '<li style="padding: 8px;">Cargando...</li>';
                modal.style.display = 'block';
                fetchTemplates(); // Re-fetch para asegurar que est√© actualizado
            });

            closeBtn.onclick = () => { modal.style.display = "none"; };
            window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; };

            deleteBtn.addEventListener('click', function() {
                const selectedId = deleteSelect.value;
                const selectedName = deleteSelect.options[deleteSelect.selectedIndex].text;
                if (!selectedId) return;

                templateIdToDelete = selectedId;
                deleteModalText.textContent = `¬øEst√°s seguro de que quieres borrar la plantilla "${selectedName}"? Esta acci√≥n no se puede deshacer.`;
                deleteConfirmModal.style.opacity = '1';
                deleteConfirmModal.style.visibility = 'visible';
            });

            deleteCancelBtn.onclick = () => {
                deleteConfirmModal.style.opacity = '0';
                deleteConfirmModal.style.visibility = 'hidden';
                templateIdToDelete = null;
            };

            deleteConfirmBtn.addEventListener('click', function() {
                if (!templateIdToDelete) return;

                fetch(`/delete_template/${templateIdToDelete}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message || `Error: ${data.error}`);
                        if (data.success) {
                            fetchTemplates(); // Recargar la lista
                        }
                    });
                
                deleteCancelBtn.onclick(); // Cerrar modal
            });

            // Cargar plantillas al inicio si el usuario est√° conectado
            {% if credentials_exist %}
                fetchTemplates();
            {% endif %}
        });
        </script>

        <fieldset>
            <legend>Subida de Recursos</legend>
            {% if not credentials_exist %}
                <p>Para subir tus im√°genes y v√≠deos, primero necesitas conectar tu cuenta de Google.</p>
                <a href="/authorize" class="auth-button">Conectar con Google</a>
                <div class="status-indicator status-disconnected">Estado: No conectado</div>
            {% else %}
                <div class="status-indicator status-connected">Estado: Conectado a Google. ¬°Listo para subir!</div>
            {% endif %}
            
            <div id="upload-section" {% if not credentials_exist %}style="display:none;"{% endif %}>
                
                <h4>Configuraci√≥n de Google Drive</h4>
                <div class="resource-item">
                    <label for="drive_folder_select" class="resource-label">Seleccionar Carpeta Existente:</label>
                    <select id="drive_folder_select" style="flex-grow: 1; padding: 10px; margin-bottom: 0;"></select>
                    <button type="button" class="upload-button" onclick="fetchDriveFolders()">Refrescar Lista</button>
                </div>
                <div class="resource-item">
                    <label for="drive_folder_name" class="resource-label">O Crear Carpeta Nueva:</label>
                    <input type="text" id="drive_folder_name" placeholder="Ej: Newsletter_Imagenes_2024" style="margin-bottom: 0;">
                    <button type="button" class="upload-button" onclick="getOrCreateFolder()">Crear y Usar</button>
                </div>
                <input type="hidden" id="drive_folder_id" name="drive_folder_id" value="{{ form_data.drive_folder_id }}">
                <hr style="margin: 2em 0;">

                <h4>Im√°genes (subir a Google Drive)</h4>
                <p>Selecciona todas las im√°genes que quieras subir. Despu√©s, pulsa el bot√≥n de abajo para subirlas todas a la vez.</p>
                <div class="resource-item">
                    <label for="header_logo_src_upload" class="resource-label">Logo (Cabecera):</label>
                    <input type="file" id="header_logo_src_upload" accept="image/*" data-target-input="header_logo_src">
                    <span class="image-selector-placeholder" data-target-input="header_logo_src"></span>
                </div>
                <div class="resource-item">
                    <label for="hero_src_upload" class="resource-label">Banner Principal:</label>
                    <input type="file" id="hero_src_upload" accept="image/*" data-target-input="hero_src">
                    <span class="image-selector-placeholder" data-target-input="hero_src"></span>
                </div>
                <div class="resource-item">
                    <label for="section1_img_src_upload" class="resource-label">Imagen (Secci√≥n 1):</label>
                    <input type="file" id="section1_img_src_upload" accept="image/*" data-target-input="section1_img_src">
                    <span class="image-selector-placeholder" data-target-input="section1_img_src"></span>
                </div>
                <div class="resource-item">
                    <label for="section2_img_src_upload" class="resource-label">Imagen (Secci√≥n 2):</label>
                    <input type="file" id="section2_img_src_upload" accept="image/*" data-target-input="section2_img_src">
                    <span class="image-selector-placeholder" data-target-input="section2_img_src"></span>
                </div>
                 <div class="resource-item">
                    <label for="video_thumbnail_src_upload" class="resource-label">Miniatura V√≠deo:</label>
                    <input type="file" id="video_thumbnail_src_upload" accept="image/*" data-target-input="video_thumbnail_src">
                    <span class="image-selector-placeholder" data-target-input="video_thumbnail_src"></span>
                </div>
                <div class="button-container" style="margin: 1em 0;">
                    <button type="button" class="upload-button" onclick="uploadAllImages()">Subir Todas las Im√°genes Seleccionadas</button>
                </div>
                <div class="button-container" style="margin: 1em 0;">
                    <!-- Nuevo bot√≥n para revisar im√°genes -->
                    <button type="button" class="upload-button" style="background-color: #6c757d;" onclick="reviewImages()">Revisar Im√°genes de la Carpeta</button>
                </div>

                <h4>V√≠deo (subir a YouTube)</h4>
                <div class="resource-item">
                    <label for="video_link_upload" class="resource-label">V√≠deo Principal:</label>
                    <input type="file" id="video_link_upload" accept="video/*">
                    <button type="button" class="upload-button" onclick="uploadVideo('video_link_upload', 'video_link')">Subir V√≠deo</button>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>1. Cabecera y Banner</legend>
            <label for="title">T√≠tulo de la P√°gina (pesta√±a del navegador):</label>
            <input type="text" id="title" name="title" value="{{ form_data.title | default('Newsletter CITED Cantabria') }}">

            <label for="header_logo_link">Enlace del Logo (Cabecera):</label>
            <input type="text" id="header_logo_link" name="header_logo_link" value="{{ form_data.header_logo_link | default('https://educantabria.es/web/cited') }}">

            <label for="header_logo_src">URL de la Imagen del Logo (Cabecera):</label>
            <input type="text" id="header_logo_src" name="header_logo_src" value="{{ form_data.header_logo_src | default('https://www.educantabria.es/documents/21790824/0/Logo+Cited_Aula+del+futuro+%281%29.png') }}">

            <label for="hero_link">Enlace del Banner Principal:</label>
            <input type="text" id="hero_link" name="hero_link" value="{{ form_data.hero_link | default('https://educantabria.es/web/cited') }}">

            <label for="hero_src">URL de la Imagen del Banner Principal:</label>
            <input type="text" id="hero_src" name="hero_src" value="{{ form_data.hero_src | default('https://www.educantabria.es/documents/21790824/21790904/artificial-intelligence-3706562_1920.jpg') }}">

            <label for="hero_alt">Texto Alternativo del Banner Principal:</label>
            <input type="text" id="hero_alt" name="hero_alt" value="{{ form_data.hero_alt | default('Innovaci√≥n y Formaci√≥n CITED') }}">
        </fieldset>

        <fieldset>
            <legend>2. Contenido Introductorio</legend>
            <label for="intro_title">T√≠tulo Principal:</label>
            <input type="text" id="intro_title" name="intro_title" value="{{ form_data.intro_title | default('Descubre el CITED: Tu Futuro Empieza Aqu√≠') }}">

            <label for="intro_p1">P√°rrafo de Introducci√≥n 1:</label>
            <textarea id="intro_p1" name="intro_p1">{{ form_data.intro_p1 | default('El &lt;strong&gt;Centro de Innovaci√≥n y Tecnolog√≠a Educativa de Cantabria (CITED)&lt;/strong&gt; es tu punto de referencia para la transformaci√≥n digital en la educaci√≥n.') }}</textarea>

            <label for="intro_p2">P√°rrafo de Introducci√≥n 2:</label>
            <textarea id="intro_p2" name="intro_p2">{{ form_data.intro_p2 | default('Explora nuestras nuevas l√≠neas de formaci√≥n, programas, recursos y proyectos dise√±ados para &lt;strong&gt;docentes&lt;/strong&gt; que buscan innovar en el aula.') | safe }}</textarea>
        </fieldset>

        <fieldset>
            <legend>Secci√≥n 1</legend>
            {% set section1 = form_data.sections[0] if form_data.sections and form_data.sections|length > 0 else {} %}
            <label for="section1_img_src">URL de la Imagen (Secci√≥n 1):</label>
            <input type="text" id="section1_img_src" name="section1_img_src" value="{{ section1.img_src | default('https://www.educantabria.es/documents/21790824/21790904/formacion.png') }}">

            <label for="section1_img_alt">Texto Alternativo de la Imagen (Secci√≥n 1):</label>
            <input type="text" id="section1_img_alt" name="section1_img_alt" value="{{ section1.img_alt | default('Formaci√≥n para Docentes') }}">

            <label for="section1_title">T√≠tulo (Secci√≥n 1):</label>
            <input type="text" id="section1_title" name="section1_title" value="{{ section1.title | default('Formaci√≥n del Profesorado') }}">

            <label for="section1_p">P√°rrafo (Secci√≥n 1):</label>
            <textarea id="section1_p" name="section1_p">{{ section1.p | default('Actualiza tus competencias digitales, descubre metodolog√≠as activas y lidera el cambio en tu aula. Ofrecemos cursos pr√°cticos, p√≠ldoras formativas y asesoramiento en proyectos de innovaci√≥n.') }}</textarea>

            <label for="section1_button_link">Enlace del Bot√≥n (Secci√≥n 1):</label>
            <input type="text" id="section1_button_link" name="section1_button_link" value="{{ section1.button_link | default('https://aulacited.educantabria.es') }}">

            <label for="section1_button_text">Texto del Bot√≥n (Secci√≥n 1):</label>
            <input type="text" id="section1_button_text" name="section1_button_text" value="{{ section1.button_text | default('Ver Cursos para Docentes') }}">
        </fieldset>

        <fieldset>
            <legend>Secci√≥n 2</legend>
            {% set section2 = form_data.sections[1] if form_data.sections and form_data.sections|length > 1 else {} %}
            <label for="section2_img_src">URL de la Imagen (Secci√≥n 2):</label>
            <input type="text" id="section2_img_src" name="section2_img_src" value="{{ section2.img_src | default('https://www.educantabria.es/documents/21790824/21790904/programas.png') }}">

            <label for="section2_img_alt">Texto Alternativo de la Imagen (Secci√≥n 2):</label>
            <input type="text" id="section2_img_alt" name="section2_img_alt" value="{{ section2.img_alt | default('Programas CITED') }}">

            <label for="section2_title">T√≠tulo (Secci√≥n 2):</label>
            <input type="text" id="section2_title" name="section2_title" value="{{ section2.title | default('Nuestros Programas') }}">

            <label for="section2_p">P√°rrafo (Secci√≥n 2):</label>
            <textarea id="section2_p" name="section2_p">{{ section2.p | default('Descubre los programas de innovaci√≥n que impulsamos desde el CITED, dise√±ados para fomentar la integraci√≥n de la tecnolog√≠a y las nuevas metodolog√≠as en los centros educativos de Cantabria.') }}</textarea>

            <label for="section2_button_link">Enlace del Bot√≥n (Secci√≥n 2):</label>
            <input type="text" id="section2_button_link" name="section2_button_link" value="{{ section2.button_link | default('https://www.educantabria.es/web/cited/programas1') }}">

            <label for="section2_button_text">Texto del Bot√≥n (Secci√≥n 2):</label>
            <input type="text" id="section2_button_text" name="section2_button_text" value="{{ section2.button_text | default('Ver Todos los Programas') }}">
        </fieldset>

        <div id="dynamic-sections-container">
            <!-- Las nuevas secciones se insertar√°n aqu√≠ -->
        </div>

        <div class="button-container" style="margin-bottom: 2em;">
            <button type="button" class="upload-button" onclick="addSection()">A√±adir Secci√≥n</button>
        </div>

        <fieldset>
            <legend>Secci√≥n de V√≠deo</legend>
            <label for="video_title">T√≠tulo del V√≠deo:</label>
            <input type="text" id="video_title" name="video_title" value="{{ form_data.video_title | default('Conoce el CITED en 1 Minuto') }}">

            <label for="video_p">P√°rrafo del V√≠deo:</label>
            <textarea id="video_p" name="video_p">{{ form_data.video_p | default('Descubre nuestras instalaciones y todo lo que podemos ofrecerte en este breve video.') }}</textarea>

            <label for="video_link">Enlace al Archivo de V√≠deo o P√°gina:</label>
            <input type="text" id="video_link" name="video_link" value="{{ form_data.video_link | default('https://www.educantabria.es/documents/21790824/21790889/Bienvenid%40s+al+CITED.mp4') }}">

            <label for="video_thumbnail_src">URL de la Imagen Miniatura del V√≠deo:</label>
            <input type="text" id="video_thumbnail_src" name="video_thumbnail_src" value="{{ form_data.video_thumbnail_src | default('https://www.educantabria.es/documents/21790824/21790904/video.png') }}">

            <label for="video_thumbnail_alt">Texto Alternativo de la Miniatura:</label>
            <input type="text" id="video_thumbnail_alt" name="video_thumbnail_alt" value="{{ form_data.video_thumbnail_alt | default('Ver video sobre el CITED') }}">
        </fieldset>

        <fieldset>
            <legend>7. Estilos de la Newsletter</legend>

            <label for="bg_type">Tipo de Fondo:</label>
            <select id="bg_type" name="bg_type">
                <option value="solid" {% if form_data.bg_type == 'solid' %}selected{% endif %}>Color S√≥lido</option>
                <option value="gradient" {% if form_data.bg_type == 'gradient' %}selected{% endif %}>Degradado</option>
            </select>

            <div id="solid_color_picker" style="display:{% if form_data.bg_type == 'gradient' %}none{% else %}block{% endif %};">
                <label for="bg_color">Color de Fondo:</label>
                <input type="color" id="bg_color" name="bg_color" value="{{ form_data.bg_color|default('#f2f2f2') }}">
            </div>

            <div id="gradient_color_picker" style="display:{% if form_data.bg_type == 'gradient' %}block{% else %}none{% endif %};">
                <label for="bg_color_1">Color de Fondo 1:</label>
                <input type="color" id="bg_color_1" name="bg_color_1" value="{{ form_data.bg_color_1|default('#f2f2f2') }}">
                <label for="bg_color_2">Color de Fondo 2:</label>
                <input type="color" id="bg_color_2" name="bg_color_2" value="{{ form_data.bg_color_2|default('#ffffff') }}">
            </div>

            <label for="title_color">Color de los T√≠tulos:</label>
            <input type="color" id="title_color" name="title_color" value="{{ form_data.title_color|default('#333333') }}">

            <label for="title_font_size">Tama√±o de los T√≠tulos:</label>
            <select id="title_font_size" name="title_font_size">
                <option value="20px" {% if form_data.title_font_size == '20px' %}selected{% endif %}>20px</option>
                <option value="24px" {% if form_data.title_font_size == '24px' %}selected{% endif %}>24px</option>
                <option value="28px" {% if form_data.title_font_size == '28px' %}selected{% endif %}>28px</option>
                <option value="32px" {% if form_data.title_font_size == '32px' %}selected{% endif %}>32px</option>
            </select>

            <label for="text_color">Color de los P√°rrafos:</label>
            <input type="color" id="text_color" name="text_color" value="{{ form_data.text_color|default('#555555') }}">

            <label for="button_color">Color de los Botones:</label>
            <input type="color" id="button_color" name="button_color" value="{{ form_data.button_color|default('#005a9e') }}">

            <label for="font_family">Tipo de Fuente:</label>
            <select id="font_family" name="font_family">
                <option value="Arial, sans-serif" {% if form_data.font_family == 'Arial, sans-serif' %}selected{% endif %}>Arial</option>
                <option value="Georgia, serif" {% if form_data.font_family == 'Georgia, serif' %}selected{% endif %}>Georgia</option>
                <option value="'Times New Roman', Times, serif" {% if form_data.font_family == "'Times New Roman', Times, serif" %}selected{% endif %}>Times New Roman</option>
                <option value="'Courier New', Courier, monospace" {% if form_data.font_family == "'Courier New', Courier, monospace" %}selected{% endif %}>Courier New</option>
                <option value="Verdana, Geneva, sans-serif" {% if form_data.font_family == 'Verdana, Geneva, sans-serif' %}selected{% endif %}>Verdana</option>
                <option value="'Roboto', sans-serif" {% if form_data.font_family == "'Roboto', sans-serif" %}selected{% endif %}>Roboto</option>
                <option value="'Open Sans', sans-serif" {% if form_data.font_family == "'Open Sans', sans-serif" %}selected{% endif %}>Open Sans</option>
                <option value="'Lato', sans-serif" {% if form_data.font_family == "'Lato', sans-serif" %}selected{% endif %}>Lato</option>
            </select>
        </fieldset>

        <fieldset>
            <legend>8. Pie de P√°gina</legend>
            <label for="footer_text_main">Texto Principal del Pie de P√°gina:</label>
            <textarea id="footer_text_main" name="footer_text_main">{{ form_data.footer_text_main | default('<strong>CITED - Centro de Innovaci√≥n y Tecnolog√≠a Educativa</strong><br>Consejer√≠a de Educaci√≥n, Formaci√≥n Profesional y Universidades<br>Gobierno de Cantabria') }}</textarea>

            <label for="footer_web_link">Enlace Web del Pie de P√°gina:</label>
            <input type="text" id="footer_web_link" name="footer_web_link" value="{{ form_data.footer_web_link | default('https://educantabria.es/web/cited') }}">

            <label for="footer_web_text">Texto del Enlace Web del Pie de P√°gina:</label>
            <input type="text" id="footer_web_text" name="footer_web_text" value="{{ form_data.footer_web_text | default('educantabria.es/web/cited') }}">

            <label for="footer_legal_text">Texto Legal/Secundario del Pie de P√°gina:</label>
            <textarea id="footer_legal_text" name="footer_legal_text">{{ form_data.footer_legal_text | default('Has recibido este correo como miembro de la comunidad educativa.') | safe }}</textarea>
        </fieldset>

        <div class="button-container">
            <input type="submit" value="Generar Newsletter">
        </div>

    </form>

    <script>
        var formData = {{ form_data | tojson }};

        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const currentTheme = localStorage.getItem('theme');

            if (currentTheme) {
                document.body.classList.add(currentTheme);
                if (currentTheme === 'dark-mode') {
                    themeToggle.textContent = '‚òÄÔ∏è';
                }
            }

            themeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                let theme = 'light-mode';
                if (document.body.classList.contains('dark-mode')) {
                    theme = 'dark-mode';
                    themeToggle.textContent = '‚òÄÔ∏è';
                } else {
                    themeToggle.textContent = 'üåô';
                }
                localStorage.setItem('theme', theme);
            });

            document.getElementById('bg_type').addEventListener('change', function() {
                var solidPicker = document.getElementById('solid_color_picker');
                var gradientPicker = document.getElementById('gradient_color_picker');
                if (this.value === 'solid') {
                    solidPicker.style.display = 'block';
                    gradientPicker.style.display = 'none';
                } else {
                    solidPicker.style.display = 'none';
                    gradientPicker.style.display = 'block';
                }
            });

            // Event listener para el dropdown de carpetas
            document.getElementById('drive_folder_select').addEventListener('change', function() {
                document.getElementById('drive_folder_id').value = this.value;
                updateImageSelectors(this.value);
            });

            // Repoblar secciones din√°micas
            if (window.formData && window.formData.sections) {
                const sectionsData = window.formData.sections;
                // Empezamos a a√±adir desde la tercera secci√≥n (√≠ndice 2)
                if (sectionsData.length > 2) {
                    for (let i = 2; i < sectionsData.length; i++) {
                        // Pasamos los datos de la secci√≥n a la funci√≥n para que los repueble
                        addSection(sectionsData[i]);
                    }
                }
            }

            // Si el usuario est√° conectado, carga las carpetas de Drive.
            if (document.getElementById('upload-section').style.display !== 'none') {
                fetchDriveFolders(); // Esto ahora se encargar√° de llamar a updateImageSelectors
            }
        });

        function fetchDriveFolders() {
            const select = document.getElementById('drive_folder_select');
            const currentFolderId = document.getElementById('drive_folder_id').value;
            select.innerHTML = '<option>Cargando carpetas...</option>';

            fetch('/list_drive_folders')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar la lista de carpetas.');
                    return response.json();
                })
                .then(folders => {
                    select.innerHTML = '';
                    if (folders.length === 0) {
                        select.innerHTML = '<option value="">No se encontraron carpetas</option>';
                        return;
                    }
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = folder.name;
                        if (folder.id === currentFolderId) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    // Asegurarse de que el hidden input tenga el valor correcto al cargar
                    if (select.value) {
                        const selectedFolderId = select.value;
                        document.getElementById('drive_folder_id').value = selectedFolderId;
                        updateImageSelectors(selectedFolderId); // Llamar a la actualizaci√≥n de im√°genes DESPU√âS de tener la carpeta
                    }
                })
                .catch(error => {
                    console.error('Error fetching folders:', error);
                    select.innerHTML = '<option value="">Error al cargar</option>';
                });
        }

        function getOrCreateFolder() {
            const folderName = document.getElementById('drive_folder_name').value;
            if (!folderName) {
                alert("Por favor, introduce un nombre para la carpeta nueva.");
                return;
            }

            const formData = new FormData();
            formData.append('folderName', folderName);

            fetch('/get_or_create_folder', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.folderId) {
                    document.getElementById('drive_folder_id').value = data.folderId;
                    alert(`Carpeta '${folderName}' lista para usar.`);
                    // Refrescar la lista y seleccionar la nueva carpeta
                    fetchDriveFolders();
                } else {
                    throw new Error(data.error || 'No se pudo obtener el ID de la carpeta.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error al procesar la carpeta: " + error.message);
            });
        }

        let sectionCounter = 3; // Empezamos desde 3 porque 1 y 2 ya existen

        function addSection(data = {}) {
            const container = document.getElementById('dynamic-sections-container');
            const sectionId = sectionCounter;

            const newSection = document.createElement('fieldset');
            newSection.id = `section-${sectionId}`;
            newSection.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
                    <legend style="margin-bottom: 0; border-bottom: none; padding-bottom: 0;">Secci√≥n ${sectionId}</legend>
                    <button type="button" class="upload-button" onclick="removeSection(${sectionId})" style="margin-top: 0; margin-left: 0; padding: 8px 15px; font-size: 0.9em; background-color: #dc3545;">Eliminar Secci√≥n</button>
                </div>
                
                <div class="resource-item">
                    <label for="section${sectionId}_img_src_upload" class="resource-label">Imagen (Secci√≥n ${sectionId}):</label>
                    <input type="file" id="section${sectionId}_img_src_upload" accept="image/*" data-target-input="section${sectionId}_img_src">
                    <span class="image-selector-placeholder" data-target-input="section${sectionId}_img_src"></span>
                    <button type="button" class="upload-button" onclick="uploadSingleImageFromInput('section${sectionId}_img_src_upload')" style="margin-left: 10px;">Subir</button>
                </div>

                <label for="section${sectionId}_img_src">URL de la Imagen (Secci√≥n ${sectionId}):</label>
                <input type="text" id="section${sectionId}_img_src" name="section${sectionId}_img_src" value="${data.img_src || ''}">

                <label for="section${sectionId}_img_alt">Texto Alternativo de la Imagen (Secci√≥n ${sectionId}):</label>
                <input type="text" id="section${sectionId}_img_alt" name="section${sectionId}_img_alt" value="${data.img_alt || ''}">

                <label for="section${sectionId}_title">T√≠tulo (Secci√≥n ${sectionId}):</label>
                <input type="text" id="section${sectionId}_title" name="section${sectionId}_title" value="${data.title || ''}">

                <label for="section${sectionId}_p">P√°rrafo (Secci√≥n ${sectionId}):</label>
                <textarea id="section${sectionId}_p" name="section${sectionId}_p">${data.p || ''}</textarea>

                <label for="section${sectionId}_button_link">Enlace del Bot√≥n (Secci√≥n ${sectionId}):</label>
                <input type="text" id="section${sectionId}_button_link" name="section${sectionId}_button_link" value="${data.button_link || ''}">

                <label for="section${sectionId}_button_text">Texto del Bot√≥n (Secci√≥n ${sectionId}):</label>
                <input type="text" id="section${sectionId}_button_text" name="section${sectionId}_button_text" value="${data.button_text || ''}">
            `;

            container.appendChild(newSection);
            
            // Inicializar TinyMCE en el nuevo textarea
            tinymce.init({
                selector: `#section${sectionId}_p`,
                plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak',
                toolbar_mode: 'floating',
            });

            sectionCounter++;
        }

        function removeSection(sectionId) {
            const section = document.getElementById(`section-${sectionId}`);
            if (section) {
                // Destruir la instancia de TinyMCE antes de eliminar el elemento
                const editor = tinymce.get(`section${sectionId}_p`);
                if (editor) {
                    editor.destroy();
                }
                section.remove();
            }
        }

        function updateImageSelectors(folderId) {
            if (!folderId) return;

            fetch(`/list_images_in_folder/${folderId}`)
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar la lista de im√°genes.');
                    return response.json();
                })
                .then(images => {
                    const placeholders = document.querySelectorAll('.image-selector-placeholder');
                    placeholders.forEach(placeholder => {
                        // Limpiar selector previo
                        placeholder.innerHTML = '';

                        if (images.length === 0) return;

                        const targetInputId = placeholder.getAttribute('data-target-input');
                        const select = document.createElement('select');
                        select.classList.add('image-reuse-selector');
                        select.setAttribute('data-target-input', targetInputId);
                        select.style.marginLeft = '10px';
                        select.style.maxWidth = '200px';

                        // Opci√≥n por defecto
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'O seleccionar existente...';
                        select.appendChild(defaultOption);

                        // Llenar con im√°genes
                        images.forEach(image => {
                            const option = document.createElement('option');
                            option.value = image.url;
                            option.textContent = image.name;
                            select.appendChild(option);
                        });

                        placeholder.appendChild(select);
                    });
                })
                .catch(error => {
                    console.error('Error fetching images:', error);
                });
        }

        async function uploadAllImages() {
            // 1. Procesar los desplegables de reutilizaci√≥n de im√°genes
            const imageSelectors = document.querySelectorAll('.image-reuse-selector');
            let selectorsProcessed = 0;
            imageSelectors.forEach(select => {
                const imageUrl = select.value;
                if (imageUrl) {
                    const targetInputId = select.getAttribute('data-target-input');
                    const targetInput = document.getElementById(targetInputId);
                    if (targetInput) {
                        targetInput.value = imageUrl;
                        selectorsProcessed++;
                    }
                }
            });

            if (selectorsProcessed > 0) {
                alert(`${selectorsProcessed} campo(s) de imagen actualizados desde los desplegables.`);
            }

            // 2. Proceder con la subida de nuevos archivos
            const uploadButton = document.querySelector('button[onclick="uploadAllImages()"]');
            const originalButtonText = uploadButton.textContent;
            
            const folderId = document.getElementById('drive_folder_id').value;
            if (!folderId) {
                alert("Por favor, primero crea o verifica una carpeta de Google Drive para subir nuevos archivos.");
                return;
            }

            const fileInputs = document.querySelectorAll('input[type="file"][data-target-input]');
            const filesToUpload = Array.from(fileInputs).filter(input => input.files.length > 0);

            if (filesToUpload.length === 0) {
                if (selectorsProcessed === 0) {
                    alert("No has seleccionado ninguna imagen para subir ni has elegido ninguna de los desplegables.");
                }
                return;
            }

            uploadButton.textContent = "Subiendo...";
            uploadButton.disabled = true;

            const uploadPromises = filesToUpload.map(fileInput => {
                const file = fileInput.files[0];
                const targetInputId = fileInput.getAttribute('data-target-input');
                return _uploadSingleImage(file, folderId, targetInputId);
            });

            try {
                const results = await Promise.all(uploadPromises);
                const successfulUploads = results.filter(r => r.success).length;
                const failedUploads = results.length - successfulUploads;

                // Resetear los inputs de archivo que tuvieron √©xito
                results.forEach((result, index) => {
                    if (result.success) {
                        filesToUpload[index].value = null; // ¬°Esta l√≠nea resetea el campo del archivo!
                    }
                });

                let message = `${successfulUploads} de ${results.length} im√°genes nuevas subidas con √©xito.`;
                if (failedUploads > 0) {
                    message += `\n${failedUploads} subidas fallaron. Revisa la consola para m√°s detalles.`;
                };
                alert(message);

            } catch (error) {
                console.error('Error general durante la subida de im√°genes:', error);
                alert('Ocurri√≥ un error inesperado al subir las im√°genes.');
            } finally {
                uploadButton.textContent = originalButtonText;
                uploadButton.disabled = false;
            }
        }

        function _uploadSingleImage(file, folderId, targetInputId) {
            return new Promise((resolve) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('folderId', folderId);

                const targetInput = document.getElementById(targetInputId);
                const originalValue = targetInput.value;

                fetch('/upload_image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error en subida de ${file.name}. C√≥digo: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.url) {
                        targetInput.value = data.url;
                        resolve({ success: true, file: file.name });
                    } else {
                        throw new Error(data.error || `No se recibi√≥ URL para ${file.name}.`);
                    }
                })
                .catch(error => {
                    console.error(`Error subiendo ${file.name}:`, error);
                    targetInput.value = originalValue; // Revertir
                    resolve({ success: false, file: file.name, error: error.message });
                });
            });
        }

        function reviewImages() {
            const folderId = document.getElementById('drive_folder_id').value;
            if (!folderId) {
                alert("Por favor, selecciona una carpeta primero.");
                return;
            }
            // Guardamos los datos del formulario y redirigimos
            document.querySelector('form').action = "{{ url_for('manage_images_view') }}";
            document.querySelector('form').submit();
        }

        async function uploadSingleImageFromInput(fileInputId) {
            const fileInput = document.getElementById(fileInputId);
            const file = fileInput.files[0];
            
            if (!file) {
                alert("Por favor, selecciona un archivo de imagen primero.");
                return;
            }

            const folderId = document.getElementById('drive_folder_id').value;
            if (!folderId) {
                alert("Por favor, primero crea o verifica una carpeta de Google Drive.");
                return;
            }

            const targetInputId = fileInput.getAttribute('data-target-input');
            const uploadButton = fileInput.nextElementSibling.nextElementSibling; // Asumiendo que el bot√≥n est√° despu√©s del span
            const originalButtonText = uploadButton.textContent;

            uploadButton.textContent = "Subiendo...";
            uploadButton.disabled = true;

            try {
                const result = await _uploadSingleImage(file, folderId, targetInputId);
                if (result.success) {
                    alert(`Imagen '${file.name}' subida con √©xito.`);
                    fileInput.value = null; // Resetear el input de archivo
                } else {
                    alert(`Error al subir '${file.name}': ${result.error}`);
                }
            } catch (error) {
                console.error('Error subiendo imagen individual:', error);
                alert('Ocurri√≥ un error inesperado al subir la imagen.');
            } finally {
                uploadButton.textContent = originalButtonText;
                uploadButton.disabled = false;
            }
        }

        function uploadVideo(fileInputId, targetInputId) {
            const fileInput = document.getElementById(fileInputId);
            const file = fileInput.files[0];
            if (!file) {
                alert("Por favor, selecciona un archivo de v√≠deo primero.");
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const targetInput = document.getElementById(targetInputId);
            const originalValue = targetInput.value;
            const uploadButton = fileInput.nextElementSibling;
            uploadButton.textContent = "Subiendo...";
            uploadButton.disabled = true;

            fetch('/upload_video', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la subida. C√≥digo de estado: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.url) {
                    targetInput.value = data.url;
                    alert("¬°Subida de v√≠deo completada! La URL ha sido actualizada.");
                } else {
                    throw new Error(data.error || 'No se recibi√≥ una URL.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error en la subida del v√≠deo: " + error.message);
                targetInput.value = originalValue;
            })
            .finally(() => {
                uploadButton.textContent = "Subir V√≠deo";
                uploadButton.disabled = false;
            });
        }
    </script>

    <!-- Cargar plantillas al inicio si el usuario est√° conectado -->
    {% if credentials_exist %}
    <script>
        document.addEventListener('DOMContentLoaded', function() { fetchTemplates(); });
    </script>
    {% endif %}

</body>
</html>